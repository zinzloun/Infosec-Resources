# Securing Microsoft 365 with Hybrid AD, MFA, RBAC, PIM, and SIEM Integration

This document describes the recommended security architecture and configuration steps to secure our Microsoft 365 tenant while integrating with on-prem Active Directory (AD).

---

## 1. Identity Integration (Hybrid AD)

We will integrate on-prem Active Directory with Azure AD using **Azure AD Connect**.

### Steps:
1. **Prepare AD**:
   - Ensure all users have a valid, routable UPN suffix (e.g. `@company.com`).
   - Remove duplicate or stale accounts.
2. **Install Azure AD Connect**:
   - Deploy on a Windows Server (not a DC but domain-joined).
   - Choose **Password Hash Sync (PHS)** for simplicity and reliability.
   - Enable **Password Writeback** if self-service password reset is required.
3. **Verify Synchronization**:
   - Run `Get-ADSyncScheduler` to confirm sync frequency.
   - Validate that users appear in **Azure AD > Users**.

---

## 2. Multi-Factor Authentication (MFA)

We will enforce MFA using **Conditional Access Policies**.

### Steps:
1. In **Azure AD > Security > Conditional Access**:
   - **Block legacy authentication**: deny access from clients using basic auth (POP, IMAP, SMTP).
   - **Require MFA for all users**:
     - Assign to `All Users` (exclude 2 break-glass accounts).
     - Apply to `All cloud apps`.
     - Grant access only if MFA is satisfied.
   - **Require MFA for risky sign-ins** (via Identity Protection).
2. **User Experience**:
   - Default method: Microsoft Authenticator app.
   - Allow backup methods (SMS, voice) for flexibility.

---

## 3. Strict RBAC (Role-Based Access Control)

We will enforce the principle of **least privilege** by assigning roles based on function.

### Steps:
1. In **Azure AD > Roles and administrators**:
   - Remove permanent Global Admins (except break-glass accounts).
   - Assign only required roles:
     - **Helpdesk** → Password Administrator
     - **Exchange team** → Exchange Administrator
     - **Security team** → Security Reader / Security Operator
2. **Access Reviews** (Azure AD Premium P2 feature):
   - Schedule periodic access reviews for high-privilege roles.
   - Require justification for continued access.

---

## 4. Privileged Identity Management (PIM)

We will implement **Just-in-Time (JIT)** administrative access.

### Steps:
1. Go to **Azure AD > Privileged Identity Management (PIM)**.
2. Configure roles as **Eligible** (not permanent).
3. Require:
   - **MFA at activation**.
   - **Approval workflow** for high-impact roles (e.g. Global Admin).
   - **Justification** at role activation.
4. Set **activation duration** (e.g. 4 hours max).
5. Enable **notifications** and review **audit logs** for each activation.

**Example Policy**:
- Global Admin:
  - Eligible
  - MFA required
  - Approval required
  - Max duration: 4 hours

---

## 5. SIEM Integration (Security Onion)

We will centralize Microsoft 365 and Azure AD logs into **Security Onion** for monitoring and detection.

### Log Sources:
- **Azure AD**: sign-ins, audit logs, risky sign-ins, PIM activations.
- **Exchange Online**: mailbox audit, mail transport logs.
- **SharePoint/OneDrive**: file activity, sharing logs.
- **Defender for O365**: threat alerts and detections.

### Integration Options:
1. **Office 365 Management Activity API**:
   - Deploy a collector using o365beat
   - Forward logs via Syslog to Security Onion.
2. **Azure Monitor → Event Hub → Logstash → Security Onion**:
   - Stream Azure AD sign-in and audit logs to Event Hub.
   - Use Logstash to pull from Event Hub and forward to Security Onion.
3. **Direct API Scripts**:
   - Use PowerShell or Python to pull logs from Graph API / Defender API.
   - Forward to syslog.

---

## 6. Security Baseline Checklist

- [x] Azure AD Connect configured with PHS  
- [x] MFA enforced via Conditional Access  
- [x] Legacy authentication blocked  
- [x] RBAC applied (no standing Global Admins)  
- [x] PIM enabled for privileged roles  
- [todo] SIEM integration with Security Onion in place  
- [todo] Break-glass accounts documented and tested  

---

## 7. References

- [Azure AD Connect](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-azure-ad-connect)
- [Conditional Access](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/overview)
- [Privileged Identity Management](https://learn.microsoft.com/en-us/azure/active-directory/privileged-identity-management/pim-configure)
- [Office 365 Management Activity API](https://learn.microsoft.com/en-us/office/office-365-management-api/office-365-management-activity-api-reference)
- [Security Onion](https://securityonion.net/)

# Customer-Facing SLA / Shared-Responsibility Table
| Responsibility | Microsoft 365 / Microsoft’s Part | Customer Part |
|----------------|------------------------------------|----------------|
| Service Infrastructure / Uptime | Ensure service availability according to published SLA for Microsoft 365 services | Monitor service health; ensure that dependent configurations (like network, identity, etc.) do not violate SLA preconditions |
| Patch Management (Infrastructure-side) | Microsoft patches service components, OS, underlying platforms | Customer patches endpoints, hybrid servers, custom applications |
| Backup / Data Recovery | Provide retention / recycle bin / soft delete / retention policies; data replication in infrastructure parts | Implement backup for accidental deletion beyond retention windows, ransomware, support required RPO/RTO, use of third-party (if needed) |
| Retention Policies & Holds | Provide tools for retention policies, labels, preservation hold, preservation lock etc. | Define policies; configure them; ensure they are applied correctly; maintain them; ensure holds are in place for relevant data; plan for account/deleted user retention |
| Incident Response & Monitoring | 24/7 security monitoring; Microsoft Incident Response offerings; updates / security bulletins; threat intelligence; platform logs | Detect and escalate security events; maintain logging; enable audit logs; respond to incidents internally; coordinate with Microsoft for major incidents; keep contact / support agreements current |
| Disaster Recovery / Customer Data Restoration | Infrastructure resilience, data center redundancy, failover for infrastructure | Customer to define DR plans; test restoration; maintain backups; ensure that permissions / authorizations / identity management support recovery; ensure archival if required beyond native retention windows |
